package com.example.demo4.gui;

import com.example.demo4.Services.ServiceUser;
import javafx.animation.FadeTransition;
import javafx.animation.ScaleTransition;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.fxml.Initializable;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.image.ImageView;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.scene.text.Text;
import javafx.stage.Stage;
import javafx.util.Duration;

import java.io.IOException;
import java.net.URL;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ResourceBundle;

public class AcceuilAdminController implements Initializable {

    @FXML private VBox mainContainer;
    @FXML private ImageView adminIcon;
    @FXML private Text welcomeTitle;
    @FXML private Label userCountLabel;
    @FXML private Label activityCountLabel;
    @FXML private Button manageUsersBtn;
    @FXML private Button logoutBtn;
    @FXML private Label lastLoginLabel;
    
    private final ServiceUser userService = new ServiceUser();
    private static final DateTimeFormatter TIME_FORMAT = DateTimeFormatter.ofPattern("HH:mm");

    @Override
    public void initialize(URL url, ResourceBundle rb) {
        setupAnimations();
        loadStatistics();
        setupButtonActions();
        updateLastLoginTime();
    }
    
    private void setupAnimations() {
        // Fade in animation for the main container
        FadeTransition fadeIn = new FadeTransition(Duration.millis(800), mainContainer);
        fadeIn.setFromValue(0);
        fadeIn.setToValue(1);
        fadeIn.play();
        
        // Add hover effect to the manage users button
        addButtonHoverEffect(manageUsersBtn);
    }
    
    private void loadStatistics() {
        try {
            int totalUsers = userService.getAll().size();
            int activeUsers = userService.getActiveUsersCount(); // You'll need to implement this method
            
            userCountLabel.setText(String.format("%,d", totalUsers));
            activityCountLabel.setText(String.format("%,d", activeUsers));
            
        } catch (Exception e) {
            e.printStackTrace();
            // Handle error
        }
    }
    
    private void updateLastLoginTime() {
        String currentTime = LocalDateTime.now().format(TIME_FORMAT);
        lastLoginLabel.setText("Dernière connexion: aujourd'hui à " + currentTime);
    }
    
    private void setupButtonActions() {
        // Manage Users button
        manageUsersBtn.setOnAction(event -> openUsersManagement());
        
        // Logout button
        logoutBtn.setOnAction(event -> logout());
    }
    
    @FXML
    private void openUsersManagement() {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/com/example/demo4/ListeUsers.fxml"));
            Parent root = loader.load();
            
            Stage stage = (Stage) manageUsersBtn.getScene().getWindow();
            stage.setScene(new Scene(root));
            stage.show();
            
        } catch (IOException e) {
            e.printStackTrace();
            // Handle error
        }
    }
    
    private void logout() {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/com/example/demo4/login.fxml"));
            Parent root = loader.load();
            
            Stage stage = (Stage) logoutBtn.getScene().getWindow();
            stage.setScene(new Scene(root));
            stage.show();
            
        } catch (IOException e) {
            e.printStackTrace();
            // Handle error
        }
    }
    
    private void addButtonHoverEffect(Button button) {
        ScaleTransition scaleUp = new ScaleTransition(Duration.millis(100), button);
        scaleUp.setToX(1.05);
        scaleUp.setToY(1.05);
        
        ScaleTransition scaleDown = new ScaleTransition(Duration.millis(100), button);
        scaleDown.setToX(1.0);
        scaleDown.setToY(1.0);
        
        button.setOnMouseEntered(e -> {
            scaleUp.playFromStart();
            button.setStyle("-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 15, 0.5, 0, 3);");
        });
        
        button.setOnMouseExited(e -> {
            scaleDown.playFromStart();
            button.setStyle("-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 10, 0.5, 0, 3);");
        });
    }
}/* Style général du tableau */
.table-view {
    -fx-background-color: transparent;
    -fx-padding: 0;
    -fx-border-radius: 10;
    -fx-background-radius: 10;
    -fx-table-cell-border-color: transparent;
}

/* Style de l'en-tête du tableau */
.table-view .column-header,
.table-view .column-header-background .filler {
    -fx-background-color: #6d219c;
    -fx-background-radius: 0;
    -fx-border-radius: 0;
}

.table-view .column-header-background {
    -fx-background-color: transparent;
    -fx-background-radius: 10 10 0 0;
    -fx-border-radius: 10 10 0 0;
    -fx-padding: 0 0 5 0;
}

.table-view .column-header .label {
    -fx-text-fill: white;
    -fx-font-weight: bold;
    -fx-alignment: CENTER_LEFT;
    -fx-padding: 10 15;
}

/* Style des lignes du tableau */
.table-row-cell {
    -fx-background-color: white;
    -fx-border-color: transparent;
    -fx-table-cell-border-color: transparent;
    -fx-padding: 0 15;
}

.table-row-cell:odd {
    -fx-background-color: #f9f9f9;
}

.table-row-cell:selected {
    -fx-background-color: #f0e6ff;
    -fx-text-fill: #6d219c;
}

.table-row-cell:hover {
    -fx-background-color: #f5f0ff;
}

/* Style des cellules */
.table-cell {
    -fx-padding: 15 15;
    -fx-border-width: 0;
    -fx-text-fill: #333;
    -fx-font-size: 14px;
}

/* Style des en-têtes de colonnes */
.table-column {
    -fx-alignment: CENTER_LEFT;
}

/* Style de la barre de défilement */
.table-view .scroll-bar:vertical {
    -fx-background-color: transparent;
    -fx-padding: 0 0 10 0;
}

.table-view .scroll-bar:vertical .track {
    -fx-background-color: #f0f0f0;
    -fx-background-radius: 0 10 10 0;
}

.table-view .scroll-bar:vertical .thumb {
    -fx-background-color: #d1c4e9;
    -fx-background-radius: 5;
}

.table-view .scroll-bar:vertical .thumb:hover {
    -fx-background-color: #b39ddb;
}

/* Style du coin du tableau */
.table-view .corner {
    -fx-background-color: #6d219c;
    -fx-border-radius: 10 0 0 0;
}

/* Style pour les boutons de pagination */
.button {
    -fx-cursor: hand;
    -fx-font-weight: bold;
    -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.1), 3, 0.5, 0, 1);
}

.button:hover {
    -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 5, 0.5, 0, 2);
}

/* Style pour le champ de recherche */
.text-field {
    -fx-background-radius: 20;
    -fx-border-radius: 20;
    -fx-border-color: #9e5ac3;
    -fx-padding: 0 15 0 40;
    -fx-font-size: 14px;
    -fx-prompt-text-fill: #999;
}

.text-field:focused {
    -fx-border-color: #6d219c;
    -fx-effect: dropshadow(gaussian, rgba(109, 33, 156, 0.3), 5, 0.5, 0, 1);
}

/* Style pour les boutons d'action */
.button.action-button {
    -fx-background-color: #6d219c;
    -fx-text-fill: white;
    -fx-background-radius: 10;
    -fx-padding: 8 15;
    -fx-font-weight: bold;
}

.button.action-button:hover {
    -fx-background-color: #5b1a87;
    -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 5, 0.5, 0, 2);
}

/* Style pour les badges de statut */
.status-badge {
    -fx-padding: 3 10;
    -fx-background-radius: 10;
    -fx-font-size: 12px;
    -fx-font-weight: bold;
    -fx-text-fill: white;
}

.status-active {
    -fx-background-color: #4CAF50;
}

.status-inactive {
    -fx-background-color: #f44336;
}

.status-pending {
    -fx-background-color: #ff9800;
}

.status-blocked {
    -fx-background-color: #9e9e9e;
}
